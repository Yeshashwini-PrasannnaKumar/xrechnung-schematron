# PEPPOL Rules into the XRechnung German National Ruleset and vice versa

## Introduction

This document outlines the process of integrating PEPPOL rules into the XRechnung German national ruleset and vice versa. The integration is facilitated through an automatic transformation initiated by an Ant build script which uses files generated by the transformation script located in the `src/xsl` folder. Notably, CII rules, while integrated, come with a warning status, given they're unofficially supported by PEPPOL.
Additionally, a snippet with the German national ruleset for integration into PEPPOL can be generated using a transformation script located in the tools directory.

## Table of Contents

- [File Structure and Location](#file-structure-and-location)
- [Setting up the Ant Build Script](#setting-up-the-ant-build-script)
- [Executing the integration xr to peppol](#executing-the-integration-xr-to-peppol)
- [Executing the transformation peppol to xr](##executing-the-transformation-peppol-to-xr)

## File Structure and Location

The relevant files are located here:

```
/
|-- src/
|   |-- xsl/
|       |-- peppol-into-xr.xsl (Transformation script)
|       |-- rule-list.xml (List of rules to be transferred)
|-- build/
|   |-- bis/ (PEPPOL rules downloaded here)
|   |-- schematron/
|       |-- cii/ (Generated CII rules stored here)
|       |-- ubl/ (Generated UBL rules stored here)
|   |-- national-rules/
|       |-- XRechnung-UBL-NRS.sch (National rule set for integration in PEPPOL)
|-- tools/
    |-- xr-2-peppol-bis-billing-nrs.xsl (Transformation file for national rules)
    |-- xr-rules-list.xml (Listed rules for national transformation)
    |-- xr-variables-list.xml (Blacklist for variables not used in target rule set)
```

### Merging peppol rules with xr rules

## peppol-into-xr.xsl

This script merges the PEPPOL rules listed in `rule-list.xml` into the xrechnung rule set. It creates multiple phases for CII and UBL and added the rules from PEPPOL filtered by the rule list. Some rules are handled in a special way like `PEPPOL-EN16931-R008` and in some rules lide `PEPPOL-EN16931-R053` in CII text is replaced.

## rule-list.xml

In this file all PEPPOL rules are listed, which shall be included in XRechnung by the script.

## Executing the build target
For the XR to PEPPOL integration, the relevant target is `merge-peppol-rules-with-xr-rules` in the Ant build script. Execute the transformation with the following command:

```bash
ant merge-peppol-rules-with-xr-rules
```

In many instances, this transformation gets triggered through the `test` target.

### Transform xr rules to peppol nrs
 
 `tools/xr-2-peppol-bis-billing-nrs.xsl` generates a snippet in `build/national-rules/XRechnung-UBL-NRS.sch` to be included in the PEPPOL NRS for the German rule set. It includes the rules listed in `xr-rules-list.xml` and excludes the variables provided in `xr-variables-list.xml`.

## Executing the build target

The `transform-xr-rules-to-peppol-nrs` target within the Ant build script is for the transformation from PEPPOL to XR. To run this transformation, directly invoke the target using the command:

```bash
ant transform-xr-rules-to-peppol-nrs
```

However, it is typically initiated by the `test` target, which is also invoked by other targets.



