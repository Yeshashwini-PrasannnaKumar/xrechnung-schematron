# Harmonization of XRechnung and Peppol BIS Billing 3.0 XRechnung

## Introduction

This document outlines the process of integrating PEPPOL BIS Billing 3.0 rules into XRechnung and, vice versa, of creating the German national ruleset for Peppol BIS Billing from XRechnung national business rules.

The integration is based on an automatic transformation via Ant build script which uses files generated by the transformation script located in the `src/xsl` folder. Notably, CII rules, while integrated, come with a warning status, given they're unofficially supported by PEPPOL.
Additionally, a snippet with the German national ruleset for integration into PEPPOL can be generated using a transformation script located in the tools directory.

The transformations are initiated by Ant targets:
* `merge-peppol-rules-with-xr-rules` for integration of Peppol rules into XRechnung
* `transform-xr-rules-to-peppol-nrs` for creation of Peppol BIS Billing German National ruleset from XRechnung


## File Structure and Location

The relevant files are located here:

```
/
|-- src/
|   |-- xsl/
|       |-- peppol-into-xr.xsl (Transformation script for generation of XRechnung rules)
|       |-- rule-list.xml (Whitelist of Peppol BIS Billing rules to be transferred to XRechnung)
|-- build/
|   |-- bis/ (Peppol BIS Billing rules downloaded here)
|   |-- schematron/
|       |-- cii/ (generated CII rules stored here)
|       |-- ubl/ (generated UBL rules stored here)
|   |-- national-rules/
|       |-- XRechnung-UBL-NRS.sch (National rule set for integration into Peppol BIS Billing)
|-- tools/
    |-- xr-2-peppol-bis-billing-nrs.xsl (transformation file for creation of National Ruleset)
    |-- xr-rules-list.xml (Whitelist of XRechnung business rules to be included in National Ruleset)
    |-- xr-variables-list.xml (Blacklist of XR Schematron variables not used in target rule set)
```


## Transformation of Peppol BIS Billing rules into XRechnung

### peppol-into-xr.xsl

This script merges the PEPPOL rules listed in `rule-list.xml` into the xrechnung rule set. It creates multiple phases for CII and UBL and added the rules from PEPPOL filtered by the rule list. Some rules are handled in a special way like `PEPPOL-EN16931-R008` and in some rules lide `PEPPOL-EN16931-R053` in CII text is replaced.

### rule-list.xml

In this file all PEPPOL rules are listed, which shall be included in XRechnung by the script.

### Executing the build target
For the XR to PEPPOL integration, the relevant target is `merge-peppol-rules-with-xr-rules` in the Ant build script. Execute the transformation with the following command:

```bash
ant merge-peppol-rules-with-xr-rules
```

In many instances, this transformation gets triggered through the `test` target.

## Transform XRechnung rules to Peppol BIS Billing National Ruleset
 
 `tools/xr-2-peppol-bis-billing-nrs.xsl` generates a snippet in `build/national-rules/XRechnung-UBL-NRS.sch` to be included in the PEPPOL NRS for the German rule set. It includes the rules listed in `xr-rules-list.xml` and excludes the variables provided in `xr-variables-list.xml`.

### Executing the build target

The `transform-xr-rules-to-peppol-nrs` target within the Ant build script is for the transformation from PEPPOL to XR. To run this transformation, directly invoke the target using the command:

```bash
ant transform-xr-rules-to-peppol-nrs
```

However, it is typically initiated by the `test` target, which is also invoked by other targets.



